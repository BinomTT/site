"use strict";ASC.installBundle("ttviewer",["dbi","subst","ttonline_base"],{"/timetable/ttviewer.js":function(e,require,t){e.__esModule=!0;var Ke=require("tslib"),Xe=require("../asc/edurequest"),Ze=require("../asc/asc_react"),Je=require("../rpr/dbi"),Qe=require("react"),et=require("./currenttt"),tt=require("../asc/actions"),rt=require("./regulartt"),nt=require("../asc/lib_date"),at=require("react-dom"),it=require("../asc/asc_react2"),st=require("./server/ttviewer"),i=require("../react/datatable"),s=require("../rpr/dbi_react"),_=require("../calendar/event_popup"),b=Qe.lazy(function(){return Promise.resolve().then(function(){return require("../dashboard/dprow")})});function r(e){var t,r,n=this,h=Xe.client_req,a=e.fitheight,i=e.kiosk;Ze.useTTLang();function f(){return l(Math.min(2,p+1))}var s=Qe.useState(Ze.useResponsiveLevel()),p=s[0],l=s[1],o=Ze.useClientWidth(),u=o[0],c=o[1],d=Ze.usePrevious(u,0);Qe.useEffect(function(){d<u&&0<d&&l(0)},[u]);var m=["classes","teachers","students","classrooms","igroups","subjects"],g=h.loggedUser;if(("Admin"==g||m.indexOf(Je.DBITools.user2rowid(g).table)<0)&&(g=""),!g){var v=h.isStudentOrParent();v&&(g="Student"+v)}function _(){A("current")}function b(e){L(null),A("regular"),z(e)}var w=Qe.useState(e.user||g),y=w[0],k=w[1],T=Je.DBITools.user2rowid(y),x="*"==T.id?T.table+"_summary":T.table,E=h.timezone_date(),C=Qe.useState(e.date||e.week&&nt.week_start(h,e.week)||E),D=C[0],S=C[1],R=Qe.useState(e.num?"regular":"current"),I=R[0],A=R[1],B=Qe.useState("svg"),V=B[0],W=B[1],H=Qe.useState(!0),M=H[0],P=H[1],j=Qe.useState(e.num||""),F=j[0],z=j[1],N=Qe.useState(null),q=N[0],L=N[1];Qe.useEffect(function(){L(null)},[D,y]);var O=Qe.useState(),G=O[0],U=O[1],Y=Qe.useState(null),$=Y[0],K=Y[1],X=Qe.useState({}),Z=X[0],J=X[1],Q=nt.date_week(h,D),ee=nt.date_week(h,E),te=nt.week_delta(h,ee,-2);(h.isAdmin()||h.isUcitel()&&!h.hasRight("limited"))&&(te="");var re=nt.week_start(h,Q),ne=nt.week_end(h,Q),ae=h.getSchoolYear(D),ie=Je.strMax(re,h.schoolYear_turnOver(ae)),se=Je.strMin(ne,h.schoolYear_turnOver_end(ae)),le=Ze.useAsyncMemo(function(){return st.getTTViewerData(null,ae)},[ae],null,{interactive:!1}),oe=Ze.useLocalState("CurrentTTViewer.showColor",!le||le.defaults.showColors),ue=oe[0],ce=oe[1],de=Qe.useState(!0),me=de[0],he=de[1],fe=Qe.useState(!1),pe=fe[0],ge=fe[1],ve=mt(null!==(t=null==le?void 0:le.defaults.timeMode)&&void 0!==t&&t),_e=ve[0],be=ve[1],we=mt(null!==(r=null==le?void 0:le.defaults.swapAxis)&&void 0!==r&&r),ye=we[0],ke=we[1],Te=Qe.useState(!1),xe=Te[0],Ee=Te[1],Ce=Qe.useState(!0),De=Ce[0],Se=Ce[1],Re=Qe.useState(!1),Ie=Re[0],Ae=Re[1];Qe.useEffect(function(){a&&barWndResize()},[le]);var Be=Qe.useRef();if(Qe.useEffect(function(){if(le)if("regular"!=I||"igroups_summary"!=x){if("current"==I&&(le.current.allow||b(le.regular.default_num),"classes_summary"!=x&&"teachers_summary"!=x&&"classrooms_summary"!=x||k("")),$&&!x.endsWith("_summary")){var e=Je.DBITools.user2rowid(y),t=e.table,r=e.id;if(!$.rowData(t,r)&&Z.classes){var n=$.tableIds("classes")[0];n&&k("Trieda"+n)}}}else k("")},[I,x,le,$,y]),!le)return Qe.createElement(Ze.Loading,null);var Ve="Kruzok*",We=[{text:h.ls(1637),onClick:ct},[],{text:h.ls(1190),onClick:dt}];h.hasRight("timetable")&&(We.push([]),We.push({text:h.ls(10190),onClick:function(){return Ke.__awaiter(n,void 0,void 0,function(){return Ke.__generator(this,function(e){switch(e.label){case 0:return[4,Promise.resolve().then(function(){return require("../customize/privacy")})];case 1:return e.sent().showPrivacyPublicDlg(),[2]}})})}}));var He=[];if("current"==I&&$&&(0<He.length&&He.push([]),He.push({text:h.ttls(1009),checked:ue,onClick:function(){return ce(!ue)}}),He.push({text:h.ls(1489)+": "+h.ls(2322),checked:me,onClick:function(){return he(!me)}}),"classes"==T.table&&0<$.tableData("igroups").length&&He.push({text:h.ls(1489)+": "+$.table("igroups").name(),checked:pe,onClick:function(){return ge(!pe)}}),He.push({text:h.ttls(2858),checked:ye,onClick:function(){return ke(!ye)}}),He.push({text:h.ttls(1010),checked:xe,onClick:function(){return Ee(!xe)}}),He.length&&He.push([]),He.push({text:h.ls(6399),checked:!_e,onClick:function(){return be(!1)}}),He.push({text:h.ls(1345),checked:_e,onClick:function(){return be(!0)}})),"regular"==I&&De&&(0<He.length&&He.push([]),He.push({text:h.ttls(1009),checked:!Ie,onClick:function(){return Ae(!Ie)}})),h.props.isAsc&&(He.push([]),"regular"==I&&He.push({text:"HTML (aSc)",checked:"html"==V,onClick:function(){return W("html"==V?"svg":"html")}}),He.push({text:"Fix TT Colors (aSc)",checked:M,onClick:function(){return P(!M)}})),y&&(He.length&&He.push([]),He.push({text:tt.action_name("print"),onClick:function(){return Ke.__awaiter(n,void 0,void 0,function(){var t,r;return Ke.__generator(this,function(e){switch(e.label){case 0:return Be.current?(Be.current(),[2]):[4,Promise.resolve().then(function(){return require("../dashboard/printSheet")})];case 1:return t=e.sent().PrintSheet,r=h.ls(1001)+" - "+$.rowName(T.table,T.id),"regular"==I&&(r=h.ls(8735)),Ze.RDialog.show(Qe.createElement(t,{renderer:function(){return null},asDialog:!0,filename:r},Ye(!0))),[2]}})})}})),le&&le.regular.default_num&&le.current.allow&&(He.push([]),He.push({text:h.ls(8735),onClick:function(){"regular"==I?_():b(le.regular.default_num)},checked:"regular"==I})),He.push([]),He.push({text:ASC.ls(1248),onClick:function(){var e="https://"+ASC.edupage+".edupage.org/timetable/view.php",t=[];"regular"==I?F&&t.push("num="+F):Q!=ee&&t.push("week="+Q),T.table&&("*"==T.id?t.push("summary="+T.table):t.push(Je.DBITools.removeEs(T.table)+"="+T.id)),prompt(ASC.ls(1248)+":",e+"?"+t.join("&"))}}),h.hasRight("timetable")){var Me=Ke.__spreadArrays(We);Me.push([]),Me.push({text:h.ls(1687),onClick:ut}),0<He.length&&He.push([]),He.push({text:h.ls(2340),submenu:Me})}if(h.isAdmin()||h.isUcitel()){var Pe="";"de"==h.lang&&(Pe="https://help.edupage.org/text.php?id=3161&lang=de"),"sk"!=h.lang&&"cz"!=h.lang||(Pe="https://help.edupage.org/text.php?id=3161&lang=sk"),Pe&&(He.push([]),He.push({text:tt.action_name("help"),onClick:function(){return window.open(Pe,"_blank")}}))}if(le.asklogin){var je=h.ls(4788);return h.loggedUser||(je=Qe.createElement(Qe.Fragment,null,h.ls(2853),Qe.createElement(Ze.VGap,{height:20}),Qe.createElement(Ze.RButton,{label:h.ls(1012),onClick:function(){return document.location.href="/login/"},type:"green"}))),Qe.createElement(Qe.Fragment,null,je)}var Fe=[];if("regular"==I&&$)for(var ze=function(e){if(!Z[e+"_summary"])return"continue";Fe.push({text:$.table(e).name(),checked:T.table==e&&"*"==T.id,onClick:function(){return k(Je.DBITools.rowid2user(e,"*"))}})},Ne=0,qe=["classes","teachers","classrooms"];Ne<qe.length;Ne++){ze(qe[Ne])}function Le(e){var t=e.dbi,r=e.rights,n=e.colorsEnabled;t&&K(t),r&&J(r),"regular"==I&&null!=n&&Se(n),Be.current=e.print}var Oe={},Ge=void 0;y||(Ge=Qe.createElement(Qe.Fragment,null,Qe.createElement("i",{className:"fa fa-reply fa-rotate-90"}),Qe.createElement(Ze.HGap,{width:20}),(Z.classes||le.allow_my_items.classes)&&Qe.createElement(Qe.Fragment,null,h.ls(6801),"..."))),"regular"!=I||F||0!=le.regular.timetables.filter(function(e){return!e.hidden}).length||(Ge=Qe.createElement(Qe.Fragment,null,0<le.regular.timetables.filter(function(e){return e.year==ae}).length?h.ls(1759):h.ls(1644)+" ("+h.getSchoolYearName(ae)+")",h.hasRight("timetable")&&Qe.createElement(Qe.Fragment,null,Qe.createElement(Ze.VGap,{height:30}),Qe.createElement(Ze.RButton,{label:h.ls(1687),onClick:ut,type:"green"}))));var Ue=[];Q!=ee&&Ue.push({text:h.ls(1733),onClick:function(){return S(nt.week_start(h,ee))}}),le.regular.default_num&&!i&&(0<Ue.length&&Ue.push([]),Ue.push({text:h.ls(8735),onClick:function(){return b(le.regular.default_num)}}));var Ye=function(e){void 0===e&&(e=!1);var t=e?void 0:L;return"regular"==I?Qe.createElement(rt.RegularTTView,{tt_num:F,oblast:x,id:T.id,disableColors:Ie,mode:V,fixTTColors:M,style:{flex:"1 1 0px",minWidth:100},fit:!0,buildButtonsPortal:e?void 0:function(e){if(G)return at.createPortal(e.map(function(e,t){return Array.isArray(e)?Qe.createElement(Ze.HGap,{key:t,width:5}):Qe.createElement(lt,{key:t,text:e.text,icon:e.icon,onClick:e.onclick})}),G)},setViewData:e?void 0:Le,onTTItemClick:t,selectedTTItem:e?void 0:q}):Qe.createElement(et.CurrentTTView,{table:T.table,id:T.id,year:ae,datefrom:re,dateto:ne,showColors:ue,showIgroupsInClasses:pe,showOrig:me,showCurrentTime:!e,showHeader:!0,time_mode:_e,swapAxis:ye,fit:xe&&!e,onTTItemClick:t,selectedTTItem:e?void 0:q,setViewData:e?void 0:Le,fixTTColors:M,style:e?void 0:{flex:"1 1 0px",minWidth:100},print:e})},$e=le&&le.regular.timetables.find(function(e){return e.tt_num==F});return Qe.createElement("div",{ref:c,id:a?"fitheight":void 0,style:Ke.__assign({display:"flex",flexDirection:"column",boxSizing:"border-box",minHeight:100,height:0==p?"80vh":a?300:650,background:"#ffffff"},e.style||{})},Qe.createElement("div",{style:{display:"flex",flexDirection:"row",marginBottom:10,whiteSpace:"pre",overflowX:"auto",overflowY:"hidden"}},le.allow_my_user&&Qe.createElement(lt,{text:h.ls(3883),selected:""!=y&&y==le.allow_my_user,style:{marginRight:15},onClick:function(){return k(le.allow_my_user)},onOverflow:f}),$&&m.map(function(n){if(!Z[n]&&!le.allow_my_items[n])return null;if("regular"==I&&"igroups"==n)return null;var e=$.tableData(n).map(function(e){return Je.DBITools.rowApplyChanges(e,ne)});if("teachers"==n&&(e=e.filter(function(e){return!e.expired})),!Z[n]){if(!le.allow_my_items[n])return null;e=e.filter(function(e){return le.allow_my_items[n].includes(e.id)})}function a(e,t){var r=$.rowData(n,e);return{text:ASC.escapeHTML($.rowName(n,r.id,h.sort_name_col)+(t||"")),onClick:function(){return k(Je.DBITools.rowid2user(n,r.id))},className:r.cb_hidden?"item-old":"",checked:n==T.table&&r.id==T.id}}var i=[];if("students"==n){var r=ASC.lang_getLocale(),s=Ke.__spreadArrays(e);s.sort(function(e,t){return $.rowName(n,e.id,h.sort_name_col).localeCompare($.rowName(n,t.id,h.sort_name_col),r)});for(var t=function(t){var r=!1,e=s.filter(function(e){return e.classid==t}).map(function(e){var t=a(e.id);return r=r||t.checked,t});if(0==e.length)return"continue";i.push({text:$.rowName("classes",t),submenu:e,checked:r})},l=0,o=$.tableIds("classes");l<o.length;l++){t(o[l])}var u=s.map(function(e){return a(e.id,e.classid&&" ("+$.rowName("classes",e.classid)+")")});i.push([]),i.push({text:h.ls(2824),submenu:u})}else i=Je.DBITools.splitItemsForCombo(e).map(function(e){return a(e.id)}),"igroups"==n&&1<$.tableData(n).length&&Z.igroups_summary&&(i.push([]),i.push({text:h.ls(1349),checked:y==Ve,onClick:function(){return k(Ve)}}));if(0==e.length)return null;var c=x==n&&y!=g;"igroups"==n&&"igroups_summary"==x&&(c=!0);var d=void 0,m=$.table(n).name();return 2<=p&&(m=void 0,d=$.table(n).icon()),Qe.createElement(lt,{key:n,text:m,icon:d,selected:c,menu:i,onOverflow:f})}),0<Fe.length&&Qe.createElement(lt,{text:0==p?h.ls(1250):void 0,icon:0==p?void 0:"/static/pics/schedule_32.png",title:h.ls(1250),menu:Fe,selected:"*"==T.id}),Qe.createElement("span",{ref:function(e){return U(e)},style:{marginLeft:10,display:"flex",flexDirection:"row",minWidth:0,flexShrink:1}}),h.hasRight("timetable")&&0==p&&Qe.createElement(Qe.Fragment,null,Qe.createElement(Ze.HGap,{width:5}),Qe.createElement(lt,{text:tt.action_name("customize"),icon:"/global/pics/ui/tools.svg",menu:Ke.__spreadArrays(We)}),Qe.createElement(lt,{text:h.ls(2340),icon:"/global/pics/ui/timetables_48.svg",onClick:ut})),Qe.createElement("span",{style:{flex:1}}),"regular"==I?Qe.createElement(Qe.Fragment,null,Qe.createElement(lt,{text:$e&&$e.hidden?$e.text:h.ls(8735),style:Oe,menu:i?void 0:Ke.__spreadArrays(le.regular.timetables.filter(function(e){return!e.hidden}).map(function(e){return{text:e.text,checked:e.tt_num==F,onClick:function(){return b(e.tt_num)}}}),h.isAdmin()||h.hasRight("timetable")||h.hasRight("ttadminview")||h.isUcitel()&&!h.hasRight("limited")?[{text:h.ls(8044)+"...",onClick:function(){return Ke.__awaiter(n,void 0,void 0,function(){var t;return Ke.__generator(this,function(e){switch(e.label){case 0:return[4,Ze.RDialog.show(Qe.createElement(ht,null))];case 1:return(t=e.sent())&&b(t),[2]}})})}}]:[],le.current.allow?[[],{text:h.ls(6204),onClick:function(){return _()}}]:[]),enabled:!0})):Qe.createElement(Qe.Fragment,null,te<Q&&Qe.createElement(lt,{text:0==p?"<<":"<",style:Oe,onClick:function(){return S(nt.date_delta(ie,-1))}}),Qe.createElement(lt,{text:Q==ee?h.ls(1733):nt.date_format_2dates(h,ie,se,0==p),style:Oe,menu:Ue,enabled:!0}),Qe.createElement(lt,{text:0==p?">>":">",style:Oe,onClick:function(){return S(nt.date_delta(se,1))}})),!i&&Qe.createElement(lt,{text:Qe.createElement("i",{className:"fa fa-caret-down"}),style:Ke.__assign(Ke.__assign({},Oe),{color:"#808080"}),menu:He})),Ge&&Qe.createElement(Qe.Fragment,null,Qe.createElement("div",{style:{minHeight:0,flex:"1 1 0px",padding:15,fontSize:16,color:"#a0a0a0",boxSizing:"border-box",display:y?"none":void 0}},Ge)),Qe.createElement("div",{style:{display:Ge?"none":"flex",flexDirection:"row",minHeight:0,flex:"1 1 0px"}},Qe.createElement("div",{style:{display:"flex",flex:"1 1 0px",overflow:"auto",position:"relative"}},Ye()),q&&Qe.createElement(Qe.Fragment,null,Qe.createElement(it.VSeparatorLine,{height:"auto"}),Qe.createElement(ot,{ttitem:q,dbi:$,style:{width:250,marginRight:10},onClose:function(){return L(null)}}))))}function lt(t){var e=Ze.useHoverWithMenu(),r=e[0],n=e[1],a=e[2],i=Qe.createRef(),s=t.text,l=t.icon,o=t.title,u=t.selected,c=t.onOverflow,d=!(!t.onClick&&!t.menu),m=t.enabled;return null==m&&(m=d),Ze.useDomReader(function(){var e=i.current;e&&e.scrollWidth>e.offsetWidth&&c&&c()}),Qe.createElement("span",Ke.__assign({ref:i},n,{title:o||("string"==typeof s?s:""),style:Ke.__assign({background:m&&(r||u)?"#E3F2FD":void 0,padding:"10px 15px",borderTop:"2px solid "+(u?"#2196F3":"rgba(0,0,0,0)"),cursor:d?"pointer":void 0,textTransform:"uppercase",fontSize:12,fontWeight:u?"bold":void 0,color:m?"#333":"#ccc",flexShrink:1,minWidth:10,overflow:"hidden",textOverflow:s?"ellipsis":void 0},t.style||{}),onClick:function(e){e.preventDefault(),e.stopPropagation(),t.onClick?t.onClick(e):t.menu&&a(t.menu,e.currentTarget)},onMouseDown:function(e){return e.preventDefault()}}),l&&Qe.createElement("img",{src:l,style:{maxHeight:16,filter:m?void 0:"grayscale(100%) opacity(50%)",marginRight:s?5:void 0,verticalAlign:"middle"}}),s)}function ot(e){var t=e.ttitem,r=e.dbi,n=e.onClose,a=e.inDlg||!1,i=Xe.client_req,s=Ze.useColors(),l=t.type,o=t.date,u=t.eventids,c=t.dpRow,d=i.ls(1301),m="/static/pics/subject_32.svg";switch(l){case"event":d=i.ls(1831),m="/global/pics/ui/events_32.svg";break;case"classroomsupervision":d=i.ls(1723);break;case"absent":d=i.ls(1846),m="/global/pics/ui/subst_32.svg";break;case"subst_duty":d=i.localize("{tt:1471} ({1003})"),m="/substitution/pics/must_be_32.svg";break;case"other":m=d=""}function h(e,t){return r.tools.itemName(e)+": "+r.rowNames(e,t)}var f,p,g=Qe.useCallback(function(e){return Qe.createElement("div",{style:Ke.__assign({fontSize:16,marginBottom:5},e.style||{})},e.children)},[]),v=r.tools.ttitem_popis(t);return Qe.createElement("div",{style:Ke.__assign({position:"relative",background:s.bgWhite},e.style||{})},Qe.createElement(it.DlgHeader,{title:d,inDlg:a,icon:m,small:!0}),n&&Qe.createElement("i",{className:"fa fa-times",style:{position:"absolute",right:0,top:0,cursor:"pointer",fontSize:16,color:s.faintIcon},onClick:n}),Qe.createElement("div",{style:{padding:e.addPadding?"0px 10px 10px 10px":void 0}},Qe.createElement(g,null,nt.date_format_day(i,o,!1)),t.starttime&&Qe.createElement(g,null,nt.date_format_time0(i,t.starttime,{ajSekundy:!1})+"-"+nt.date_format_time0(i,t.endtime,{ajSekundy:!1})),Qe.createElement(Ze.VGap,{height:15}),c?Qe.createElement(Qe.Fragment,null,Ze.wrapSuspense(Qe.createElement(b,{dpRow:c,dbi:r,date:o,mode:"ttviewer"}))):Qe.createElement(Qe.Fragment,null,t.name&&Qe.createElement(g,null,t.name),t.subjectid&&Qe.createElement(g,null,(f="subjects",p=t.subjectid,h(f,p?[p]:[]))),v.class&&Qe.createElement(g,null,r.tools.itemName(t.igroupid?"igroups":"classes")+": "+v.class),0<t.teacherids.length&&Qe.createElement(g,null,h("teachers",t.teacherids)),0<t.classroomids.length&&Qe.createElement(g,null,h("classrooms",t.classroomids)),t.studentids&&0<t.studentids.length&&t.studentids.length<=3&&Qe.createElement(g,null,h("students",t.studentids)),u&&Qe.createElement(Qe.Fragment,null,Qe.createElement(Ze.VGap,{height:10}),u.map(function(e){return Qe.createElement(_.EventBar,{key:e,eventid:e,where:"timetable"})})))))}function ut(){document.location.href="/timetable/admin.php"}function ct(){ASC.ASC_action("/gcall",{gadget:"TimetableVersionAdmin",action:"settings",gsh:ASC.gsechash})}function dt(){ASC.ASC_action("/gcall",{gadget:"TimetableVersionAdmin",action:"rights",gsh:ASC.gsechash})}function mt(e){var t=Qe.useState(void 0),r=t[0];return[void 0===r?e:r,t[1]]}function n(e){var t=Ze.useReq();return Qe.createElement(Ze.RDialog,{width:1150,height:750,buttons:["close"],header:t.ls(1001)},Qe.createElement(r,Ke.__assign({},e)))}function ht(e){var t=Ze.useReq(),r=s.useMainDBI(t.getSchoolYear(),{needed_part:{timetables:["stav","name","year","datefrom","dateto","filetime_int","_uial"]},needed_combos:{timetables:["stav"]}}),n=r.tableData("timetables").filter(function(e){return 0<e._uial});n.sort(function(e,t){return t.filetime_int-e.filetime_int});var a=Ze.useStateValueRef("");return Qe.createElement(Ze.RDialog,{onConfirm:function(e){return e.confirmClose(a.value)},width:700,height:400,buttons:[{label:t.ls(1489),action:"view",type:a.value?"green":void 0},"cancel"]},Qe.createElement(i.RDatatable,{data:n,dbi:r,dbi_table:"timetables",cssClass:"light-theme",columns:["stav","year","name","datefrom","dateto"].map(function(e){return{key:e,width:{name:200,stav:100}[e]||80}}),fitWidth:!0,selectedIdRef:a,idcol:"id"}))}(e.TTViewer=r).needed_part=Je.typed({teachers:["__name","cb_hidden","expired"],classes:["__name"],classrooms:["__name"],igroups:["__name"],students:["__name","classid"],subjects:["__name"]}),e.TopButton=lt,e.TTItemDetails=ot,e.showTTViewerDlg=function(t){return Ke.__awaiter(this,void 0,void 0,function(){return Ke.__generator(this,function(e){return Ze.RDialog.show(Qe.createElement(n,Ke.__assign({},t))),[2]})})},e._hotswap=[n,ht]},"/timetable/currenttt.js":function(e,require,t){e.__esModule=!0;var K=require("tslib"),X=require("react"),Z=require("../asc/edurequest"),J=require("../asc/asc_react"),Q=require("../rpr/dbi_react"),ee=require("../asc/lib_date"),te=require("../substitution/online/timetable"),re=require("./server/currenttt"),ne=require("./ttview_components"),ae=require("../rpr/dbi"),ie=require("./ttviewer"),se=require("./app/ttdoc"),m=require("../asc/actions"),le={ttitems:[],rights:{}};function h(e){var t,i=Z.client_req,r=e.table,n=e.id,a=e.year,s=e.datefrom,l=e.dateto,o=e.showColors,u=e.showIgroupsInClasses,c=e.showOrig,d=e.showCurrentTime,m=e.showHeader,h=e.fit,f=e.onTTItemClick,p=e.selectedTTItem,g=e.highlightTTItem,v=e.time_mode,_=e.print,b=e.fixTTColors,w=J.useClientSize(),y=w[0],k=w[1],T=w[2],x=J.useColors(),E=X.useState(""),C=E[0],D=E[1];X.useEffect(function(){if(d){var e=function(){return D(i.timezone_datetime())};e();var t=setInterval(e,5e3);return function(){return clearInterval(t)}}D("")},[d]);var S=Q.useMainDBI(a,{needed_part:ae.DBITools.mergeNeededParts(ie.TTViewer,{subjects:["name","short"],teachers:["firstname","lastname","short"],classes:["__name","classroomid"],igroups:["__name"],classrooms:["name","short"],students:["classid"],events:["typ","name"],event_types:["name","icon"],subst_absents:["date","absent_typeid","groupname"],periods:["__name","period","starttime","endtime"],dayparts:["starttime","endtime"],dates:["tt_num","tt_day"]}),vt_filter:{datefrom:s,dateto:l},interactive:!1}),R=J.useAsyncMemo(function(){return re.curentttGetData(null,{year:a,datefrom:s,dateto:l,table:r,id:n,showColors:o,showIgroupsInClasses:u,showOrig:c,log_module:"CurrentTTView"})},[a,s,l,r,n,o,u,c],le,{inputs_reset:[r],interactive:!1});X.useEffect(function(){e.setViewData&&R!=le&&e.setViewData({dbi:S,rights:R.rights})},[S,R]);var I=R.error,A=R.week_name,B=null!==(t=e.swapAxis)&&void 0!==t?t:R.swapAxis,V=v&&i.jeZUS()?"hours":"periods",W=X.useMemo(function(){var e=R.ttitems;return b&&(e=e.map(function(e){return e.colors&&(e=K.__assign(K.__assign({},e),{colors:e.colors.map(function(e){return se.fixTTColor(e,x.darkMode)})})),e})),e},[R,b,x.darkMode]),H=ee.date_interval_array(s,l).filter(function(e){if(ee.date_isWeekend(i,e)){for(var t=0,r=W;t<r.length;t++){var n=r[t];if(n.date==e&&"out"!=n.type){if(n.eventid){var a=S.rowData("events",n.eventid);if(a&&("holiday"==a.typ||"sholiday"==a.typ))continue}return!0}}return!1}return!0}),M=ne.calcTTViewBoxes({clientWidth:y,clientHeight:k,fit:h,print:_,swapAxis:B,showHeader:m,time_mode:v,nDays:H.length,nPeriods:S.tableData("periods").length}),P=M.gap,j=M.gap_day,F=M.ttWidth,z=M.periodHeight,N=M.rowHeight,q=M.dayWidth,L=M.headerWidth,O=M.headerHeight,G=M.ttBox,U=M.weekBox,Y=M.ttRowBox,$=te.makeTLR(S,null,"dates",v||!1,F,z,{periods:R.periods});return $.qSide=18,$.gap=P,X.createElement(X.Fragment,null,X.createElement("div",{ref:T,style:K.__assign(K.__assign(K.__assign({},ne.ttview_div_style),{backgroundColor:x.bgWhite,color:x.fgBlack}),e.style||{}),className:"print-nobreak"},X.createElement(ne.TTView_PageHeader,{dbi:S,table:r,id:n,headerWidth:L,headerHeight:O}),I||X.createElement(ne.TTView_Boxes,{swapAxis:B,ttBox:G,tt:H.map(function(t,e){return X.createElement(ne.TTView_TTDay,{key:t,dbi:S,box:Y(e),gap_day:j,table:r,id:n,tlr:$,ttitems:S.mock?[]:W.filter(function(e){return e.date==t}),onTTItemClick:f,selectedTTItem:p,highlightTTItem:g,swapAxis:B,gridMode:V,showTime:C.substr(0,10)==t?C.substr(11):""})}),days:H.map(function(e,t){var r=N*t,n={x1:0,x2:q,y1:r,y2:r+N};return X.createElement(ne.TTView_Day,{key:e,date:e,box:n,splitLineTop:0<t,swap:B})}),periods:X.createElement(ne.TTView_Periods,{dbi:S,periodHeight:z,tlr:$,swapAxis:B,showTime:!0,periods:R.periods,gridMode:V}),corner:A&&X.createElement(J.RTextBox,K.__assign({},J.swapBox(U,B),{text:A,vAlign:"center",hAlign:"center",style:{fontSize:12,background:x.bgWhite}}))})))}function s(e){var t,r=e.year,n=e.datefrom,a=e.dateto,i=e.table,s=e.id,l=e.highlightTTItem,o=e.highlightName,u=Q.useMainDBI(r,{needed_part:(t={},t[i]=["__name"],t)}),c=Z.client_req,d=J.useStateValueRef(!0);return X.createElement(J.RDialog,{header:m.action_name("timetable")+": "+u.rowName(i,s),width:800,height:600,allowMaximizeBtn:!0,footer:X.createElement(X.Fragment,null,l&&X.createElement(J.RCheckBox,{valueRef:d,label:c.ls(1113)+": "+o}))},X.createElement(h,{datefrom:n,dateto:a,table:i,id:s,year:r,showColors:!0,highlightTTItem:d.value?l:void 0,fit:!0,style:{flex:"1 1 0px",minWidth:100}}))}e.CurrentTTView=h,e.showCurrentTimetable=function(i){return K.__awaiter(this,void 0,void 0,function(){var t,r,n,a;return K.__generator(this,function(e){return t=Z.client_req,r=i.datefrom||ee.week_start(t,i.week),n=i.dateto||ee.week_end(t,i.week),a=i.year||t.getSchoolYear(n),[2,J.RDialog.show(X.createElement(s,{table:i.table,id:i.id,datefrom:r,dateto:n,year:a,highlightTTItem:i.highlightTTItem,highlightName:i.highlightName}))]})})},e._hotswap=[s]},"/timetable/server/currenttt.js":function(e,require,t){t.implementRpc(["curentttGetData"])},"/timetable/regulartt.js":function(e,require,t){e.__esModule=!0;var Z=require("tslib"),J=require("react"),Q=require("../asc/asc_react"),ee=require("../rpr/dbi"),l=require("../asc/edurequest"),o=require("./server/regulartt"),te=require("./app/ttdoc"),C=require("./app/rokobject"),D=require("./app/print"),u=require("./ttviewer"),re=require("./ttview_components"),ne=require("../substitution/online/timetable"),ae=require("./ttitem");function r(e){var t=e.tt_num,r=l.client_req,n=Q.useAsyncMemo(function(){return e.ttdata?Promise.resolve(e.ttdata):o.regularttGetData(null,t)},[t],{rights:{}},{interactive:!1}),a=J.useMemo(function(){return n.dbiAccessorRes?ee.DBI.fromAccessorResult(r,n.dbiAccessorRes):null},[n]),i=e.mode||"svg";e.oblast.endsWith("_summary")&&(i="svg");var s=e.onTTItemClick;return r.isApp()&&(s=function(e){return Q.RDialog.show(J.createElement(Q.RDialog,{header:r.ls(1920),width:300,buttons:r.isApp()?[]:["close"],noPadding:!0},J.createElement(u.TTItemDetails,{ttitem:e,dbi:a,addPadding:!0})))}),"html"==i?J.createElement(d,Z.__assign({},e,{dbi:a,data:n,onTTItemClick:s})):J.createElement(c,Z.__assign({},e,{dbi:a,data:n}))}function c(t){var a=t.dbi,r=t.data,i=t.disableColors,s=t.oblast,l=t.id,e=t.buildButtonsPortal,o=t.fixTTColors,n=Q.useClientSize(),u=n[0],c=n[1],d=n[2],m=J.useRef(),h=J.useState(0),f=h[0],p=h[1],g=J.useState(t.fit?-1:4),v=g[0],_=g[1],b=Q.useReq(),w=J.useMemo(function(){if(!a)return[];var e=function(e){var t=new C.CRok;for(var r in C.ttapp_needed_part)if(t.m_ObjectsI[r])for(var n=0,a=e.tableData(r);n<a.length;n++){var i=a[n];t.addRow(r,i),t.dbi.addRow(r,i)}return t.StructureFromData(),t}(a),t=ie(a,s);if(!t)return[];var r={};l&&(r[s]=[l]);var n=e.m_ObjectsI.ttreports[t];return n.m_bTTViewerDisableCardColor=!!i,n.Render({filter:r,m_bTTViewer:!1,fixTTColors:o})},[a,i,s,l,o]);J.useEffect(function(){f>=w.length&&p(0)},[f,w]);var y=w[f];J.useEffect(function(){if(t.setViewData&&r){var e=a?a.rowData("ttreports",ie(a,s)):null;t.setViewData({dbi:a,rights:r.rights,colorsEnabled:!!e&&e.cardcolorenabled,print:function(){return D.printPagesPrint([y])}})}},[r,a,s,y]);var k=v;y&&v<0&&(k=10*Math.min(u/y.width,c/y.height)),J.useEffect(function(){var e=$j(m.current);if(e.empty(),y){y.$sheet=e;var t=k;y.RenderSheet(e,t,!1)}else e.text(b.ls(8467))},[f,w,k]);var T=[];1<w.length&&(T.push({id:"prevWeek",icon:"/static/pics/preview_back_32.png",onclick:0<f?function(){return p(f-1)}:void 0}),T.push({id:"nextWeek",icon:"/static/pics/preview_forward_32.png",onclick:f+1<w.length?function(){return p(f+1)}:void 0}));var x=-1,E=-1;return[2,3,4,6,10].forEach(function(e){e<k/1.1&&(E=e),1.1*k<e&&x<0&&(x=e)}),0<T.length&&T.push([]),T.push({icon:"/static/pics/zoom_plus_32.png",onclick:0<x?function(){return _(x)}:void 0}),T.push({icon:"/static/pics/zoom_minus_32.png",onclick:0<E?function(){return _(E)}:void 0}),0<v&&T.push({text:b.ls(1915),onclick:function(){return _(-1)}}),J.createElement(J.Fragment,null,J.createElement("div",{ref:d,className:"print-nobreak",style:Z.__assign({position:"relative",overflow:"auto"},t.style||{})},J.createElement("div",{ref:m,style:{marginLeft:"auto",marginRight:"auto",position:"relative"}})),e&&e(T))}function d(t){var e,r,n,a,i,v=t.dbi,_=t.data,s=t.oblast,b=t.id,w=t.fixTTColors,l=t.buildButtonsPortal,o=null===(e=t.showHeader)||void 0===e||e,u=Q.useClientSize(),c=u[0],d=u[1],m=u[2];c=null!==(r=t.clientWidth)&&void 0!==r?r:c,d=null!==(n=t.clientHeight)&&void 0!==n?n:d;var y=Q.useColors(),h=J.useState(0),f=h[0],p=h[1],g=J.useState(0),k=g[0],T=g[1];J.useEffect(function(){if(t.setViewData&&_){var e=v?v.rowData("ttreports",ie(v,s)):null;t.setViewData({dbi:v,rights:_.rights,colorsEnabled:!!e&&e.cardcolorenabled})}},[_,v,s]);var x=s,E="";"classes"==x&&(E=b),"students"==x&&(E=(null===(a=null==v?void 0:v.rowData("students",b))||void 0===a?void 0:a.classid)||"");var C=null==v?void 0:v.rowData("ttreports",ie(v,s)),D=!t.disableColors&&(null==C?void 0:C.cardcolorenabled)&&((null==C?void 0:C.cardcolortable1)||("teachers"==x?"classes":"teachers")),S=J.useMemo(function(){if(!v)return[];for(var n=[],e=0,t=v.tableData("cards");e<t.length;e++){var r=t[e];if(r.days){var a=v.rowData("lessons",r.lessonid),i={type:"card",days:r.days,weeks:r.weeks,terms:a.terms,date:"",uniperiod:r.period,starttime:"",endtime:"",subjectid:a.subjectid,classids:a.classids,teacherids:a.teacherids,groupnames:a.groupnames,classroomids:r.classroomids,studentids:a.studentids,durationperiods:a.durationperiods};if(ae.ttitemFilterMatch(i,x,b)){if("classes"==x){var s=v.rowDatas("groups",a.groupids).find(function(e){return e.classid==b});if(s){var l=v.rowData("divisions",s.divisionid);i.cellSlices="";for(var o=0,u=l.groupids;o<u.length;o++){var c=u[o];i.cellSlices+=a.groupids.includes(c)?"1":"0"}}}n.push(i)}}}if(_.rights.classroomsupervision&&("teachers"==x||"classrooms"==x))for(var d=v.tableIds("days"),m=function(t){var e=!1;if("teachers"==x&&(e=t.teacherid==b),"classrooms"==x&&(e=t.classroomid==b),!e)return"continue";var r={type:"classroomsupervision",days:d.map(function(e){return t.day==e?"1":"0"}).join(""),weeks:t.weeks,date:"",uniperiod:ee.DBITools.getUniPeriod(t),starttime:"",endtime:"",subjectid:"",classids:[],teacherids:t.teacherid?[t.teacherid]:[],groupnames:[],classroomids:[t.classroomid]};n.push(r)},h=0,f=v.tableData("classroomsupervisions")||[];h<f.length;h++){m(f[h])}for(var p=0,g=n;p<g.length;p++){i=g[p];D&&(i.colors=ae.ttitemTableIds(i,D).map(function(e){var t;return null===(t=v.rowData(D,e))||void 0===t?void 0:t.color}).filter(function(e){return e}),w&&(i.colors=i.colors.map(function(e){return te.fixTTColor(e,y.darkMode)})))}return n},[v,x,b,D,w,y.darkMode]),R=J.useMemo(function(){for(var e,t,r={terms:!1,weeks:!1},n=0,a=S;n<a.length;n++){var i=a[n];(null===(e=i.weeks)||void 0===e?void 0:e.includes("0"))&&(r.weeks=!0),(null===(t=i.terms)||void 0===t?void 0:t.includes("0"))&&(r.terms=!0)}return r},[S]);if(!v||!C)return null;var I=v.tableData("periods"),A=v.rowData("periods","0")?0:1,B=I.length||1;if(E){var V=null===(i=v.rowData("classes",E))||void 0===i?void 0:i.bell;if(V){var W=v.rowData("bells",V);I=I.map(function(e){var t=ee.patchmissingobj(null==W?void 0:W.perioddata[e.id],{});return Z.__assign(Z.__assign({},e),{starttime:t.starttime||e.starttime,endtime:t.endtime||e.endtime})})}}var H=v.tableData("days"),M=C.row_tables.includes("periods"),P=re.calcTTViewBoxes({clientWidth:c,clientHeight:d,fit:!1,swapAxis:M,showHeader:o,time_mode:!1,nDays:H.length||1,nPeriods:B}),j=P.gap,F=P.gap_day,z=P.ttWidth,N=P.periodHeight,q=P.rowHeight,L=P.dayWidth,O=P.headerWidth,G=P.headerHeight,U=P.ttBox,Y=P.ttRowBox,$=P.weekBox,K=new ne.TimetableLayoutRenderer(z,N,A,A+B);K.qSide=18,K.gap=j,K.data2t=function(e){var t,r=e.period||e.uniperiod;if("b"==r[0]){var n=parseInt(r.substr(1));return{t1:n,t2:n}}var a=parseInt(r);return{t1:a,t2:a+(null!==(t=e.durationperiods)&&void 0!==t?t:1)}};var X=[];return(R.terms||R.weeks)&&(X.push({id:"prevWeek",icon:"/static/pics/preview_back_32.png",onclick:0<f||0<k?function(){0<f?p(f-1):(p(v.tableData("weeks").length-1),T(k-1))}:void 0}),X.push({id:"nextWeek",icon:"/static/pics/preview_forward_32.png",onclick:k+1<v.tableData("terms").length||f+1<v.tableData("weeks").length?function(){f+1<v.tableData("weeks").length?p(f+1):(p(0),T(k+1))}:void 0})),J.createElement(J.Fragment,null,J.createElement("div",{ref:m,style:Z.__assign(Z.__assign(Z.__assign({},re.ttview_div_style),{backgroundColor:y.bgWhite,color:y.fgBlack}),t.style||{})},J.createElement(re.TTView_PageHeader,{dbi:v,table:x,id:b,headerWidth:O,headerHeight:G}),J.createElement(re.TTView_Boxes,{ttBox:U,swapAxis:M,periods:J.createElement(re.TTView_Periods,{dbi:v,periodHeight:N,tlr:K,swapAxis:M,showTime:!0,periods:ee.unpartial_array(I)}),days:H.map(function(e,t){var r=q*t,n={x1:0,x2:L,y1:r,y2:r+q};return J.createElement(re.TTView_Object,{key:e.id,box:n,dbi:v,table:"days",id:e.id,splitLineTop:0<t,swap:M})}),tt:H.map(function(e,n){return J.createElement(re.TTView_TTDay,{key:n,dbi:v,box:Y(n),gap_day:F,table:s,id:b,tlr:K,ttitems:S.filter(function(e){var t,r;return"1"==e.days[n]&&"0"!=(null===(t=e.weeks)||void 0===t?void 0:t[f])&&"0"!=(null===(r=e.terms)||void 0===r?void 0:r[k])}),onTTItemClick:t.onTTItemClick,selectedTTItem:t.selectedTTItem,swapAxis:M})}),corner:J.createElement(Q.RTextBox,Z.__assign({},Q.swapBox($,M),{vAlign:"center",text:[["terms",k],["weeks",f]].map(function(e){var t=e[0],r=e[1];return R[t]&&J.createElement("div",{key:t,style:{textAlign:"center"}},v.rowName(t,""+r))})}))})),l&&l(X))}function ie(e,t){for(var r=0,n=e.tableData("ttreports");r<n.length;r++){var a=n[r];if("teachers_summary"==t&&6==a.typ)return a.id;if("classes_summary"==t&&5==a.typ)return a.id;if("classrooms_summary"==t&&7==a.typ)return a.id;if(a.page_tables.includes(t))return a.id}return""}(e.RegularTTView=r).npp=ee.neededPartProvider(function(){return[d,c]}),c.npp=ee.neededPartProvider(function(){return[C.ttapp_needed_part]}),d.needed_part=ee.typed({students:["classid"],classes:["classroomid"],lessons:["studentids","groupnames"],groups:["classid","divisionid"],divisions:["groupids"],days:["__name"],weeks:["__name"],terms:["__name"],classroomsupervisions:["weeks"]}),e._hotswap=[c]},"/timetable/server/regulartt.js":function(e,require,t){t.implementRpc(["regularttGetData","ttviewDBIAccessor"])},"/timetable/server/ttviewer.js":function(e,require,t){t.implementRpc(["getTTViewerData"])}});
