"use strict";ASC.installBundle("ttviewer",["dbi","subst","ttonline_base"],{"/timetable/ttviewer.js":function(e,t,r){e.__esModule=!0;var n=t("tslib"),a=t("../asc/edurequest"),i=t("../asc/asc_react"),s=t("../rpr/dbi"),l=t("react"),o=t("./currenttt"),u=t("../asc/actions"),c=t("./regulartt"),d=t("../asc/lib_date"),m=t("react-dom"),h=t("../asc/asc_react2"),f=t("./server/ttviewer"),p=t("../react/datatable"),g=t("../rpr/dbi_react"),v=t("../calendar/event_popup"),_=l.lazy(function(){return Promise.resolve().then(function(){return t("../dashboard/dprow")})});function b(e){var r,p,g=this,v=a.client_req,_=e.fitheight,b=e.kiosk;function C(){return I(Math.min(2,R+1))}i.useTTLang();var S=l.useState(i.useResponsiveLevel()),R=S[0],I=S[1],A=i.useClientWidth(),B=A[0],V=A[1],W=i.usePrevious(B,0);l.useEffect(function(){W<B&&0<W&&I(0)},[B]);var H=["classes","teachers","students","classrooms","igroups","subjects"],M=v.loggedUser;if(("Admin"==M||H.indexOf(s.DBITools.user2rowid(M).table)<0)&&(M=""),!M){var P=v.isStudentOrParent();P&&(M="Student"+P)}function j(){Z("current")}function F(e){ue(null),Z("regular"),se(e)}var z=l.useState(e.user||M),N=z[0],q=z[1],L=s.DBITools.user2rowid(N),O="*"==L.id?L.table+"_summary":L.table,G=v.timezone_date(),U=l.useState(e.date||e.week&&d.week_start(v,e.week)||G),Y=U[0],$=U[1],K=l.useState(e.num?"regular":"current"),X=K[0],Z=K[1],J=l.useState("svg"),Q=J[0],ee=J[1],te=l.useState(!0),re=te[0],ne=te[1],ae=l.useState(e.num||""),ie=ae[0],se=ae[1],le=l.useState(null),oe=le[0],ue=le[1];l.useEffect(function(){ue(null)},[Y,N]);var ce=l.useState(),de=ce[0],me=ce[1],he=l.useState(null),fe=he[0],pe=he[1],ge=l.useState({}),ve=ge[0],_e=ge[1],be=d.date_week(v,Y),we=d.date_week(v,G),ye=d.week_delta(v,we,-2);(v.isAdmin()||v.isUcitel()&&!v.hasRight("limited"))&&(ye="");var ke=d.week_start(v,be),Te=d.week_end(v,be),xe=v.getSchoolYear(Y),Ee=s.strMax(ke,v.schoolYear_turnOver(xe)),Ce=s.strMin(Te,v.schoolYear_turnOver_end(xe)),De=i.useAsyncMemo(function(){return f.getTTViewerData(null,xe)},[xe],null,{interactive:!1}),Se=i.useLocalState("CurrentTTViewer.showColor",!De||De.defaults.showColors),Re=Se[0],Ie=Se[1],Ae=l.useState(!0),Be=Ae[0],Ve=Ae[1],We=l.useState(!1),He=We[0],Me=We[1],Pe=E(null!==(r=null==De?void 0:De.defaults.timeMode)&&void 0!==r&&r),je=Pe[0],Fe=Pe[1],ze=E(null!==(p=null==De?void 0:De.defaults.swapAxis)&&void 0!==p&&p),Ne=ze[0],qe=ze[1],Le=l.useState(!1),Oe=Le[0],Ge=Le[1],Ue=l.useState(!0),Ye=Ue[0],$e=Ue[1],Ke=l.useState(!1),Xe=Ke[0],Ze=Ke[1];l.useEffect(function(){_&&barWndResize()},[De]);var Je=l.useRef();if(l.useEffect(function(){if(De)if("regular"!=X||"igroups_summary"!=O){if("current"==X&&(De.current.allow||F(De.regular.default_num),"classes_summary"!=O&&"teachers_summary"!=O&&"classrooms_summary"!=O||q("")),fe&&!O.endsWith("_summary")){var e=s.DBITools.user2rowid(N),t=e.table,r=e.id;if(!fe.rowData(t,r)&&ve.classes){var n=fe.tableIds("classes")[0];n&&q("Trieda"+n)}}}else q("")},[X,O,De,fe,N]),!De)return l.createElement(i.Loading,null);var Qe="Kruzok*",et=[{text:v.ls(1637),onClick:T},[],{text:v.ls(1190),onClick:x}];v.hasRight("timetable")&&(et.push([]),et.push({text:v.ls(10190),onClick:function(){return n.__awaiter(g,void 0,void 0,function(){return n.__generator(this,function(e){switch(e.label){case 0:return[4,Promise.resolve().then(function(){return t("../customize/privacy")})];case 1:return e.sent().showPrivacyPublicDlg(),[2]}})})}}));var tt=[];if("current"==X&&fe&&(0<tt.length&&tt.push([]),tt.push({text:v.ttls(1009),checked:Re,onClick:function(){return Ie(!Re)}}),tt.push({text:v.ls(1489)+": "+v.ls(2322),checked:Be,onClick:function(){return Ve(!Be)}}),"classes"==L.table&&0<fe.tableData("igroups").length&&tt.push({text:v.ls(1489)+": "+fe.table("igroups").name(),checked:He,onClick:function(){return Me(!He)}}),tt.push({text:v.ttls(2858),checked:Ne,onClick:function(){return qe(!Ne)}}),tt.push({text:v.ttls(1010),checked:Oe,onClick:function(){return Ge(!Oe)}}),tt.length&&tt.push([]),tt.push({text:v.ls(6399),checked:!je,onClick:function(){return Fe(!1)}}),tt.push({text:v.ls(1345),checked:je,onClick:function(){return Fe(!0)}})),"regular"==X&&Ye&&(0<tt.length&&tt.push([]),tt.push({text:v.ttls(1009),checked:!Xe,onClick:function(){return Ze(!Xe)}})),v.props.isAsc&&(tt.push([]),"regular"==X&&tt.push({text:"HTML (aSc)",checked:"html"==Q,onClick:function(){return ee("html"==Q?"svg":"html")}}),tt.push({text:"Fix TT Colors (aSc)",checked:re,onClick:function(){return ne(!re)}})),N&&(tt.length&&tt.push([]),tt.push({text:u.action_name("print"),onClick:function(){return n.__awaiter(g,void 0,void 0,function(){var e,r;return n.__generator(this,function(n){switch(n.label){case 0:return Je.current?(Je.current(),[2]):[4,Promise.resolve().then(function(){return t("../dashboard/printSheet")})];case 1:return e=n.sent().PrintSheet,r=v.ls(1001)+" - "+fe.rowName(L.table,L.id),"regular"==X&&(r=v.ls(8735)),i.RDialog.show(l.createElement(e,{renderer:function(){return null},asDialog:!0,filename:r},ht(!0))),[2]}})})}})),De&&De.regular.default_num&&De.current.allow&&(tt.push([]),tt.push({text:v.ls(8735),onClick:function(){"regular"==X?j():F(De.regular.default_num)},checked:"regular"==X})),tt.push([]),tt.push({text:ASC.ls(1248),onClick:function(){var e="https://"+ASC.edupage+".edupage.org/timetable/view.php",t=[];"regular"==X?ie&&t.push("num="+ie):be!=we&&t.push("week="+be),L.table&&("*"==L.id?t.push("summary="+L.table):t.push(s.DBITools.removeEs(L.table)+"="+L.id)),prompt(ASC.ls(1248)+":",e+"?"+t.join("&"))}}),v.hasRight("timetable")){var rt=n.__spreadArrays(et);rt.push([]),rt.push({text:v.ls(1687),onClick:k}),0<tt.length&&tt.push([]),tt.push({text:v.ls(2340),submenu:rt})}if(v.isAdmin()||v.isUcitel()){var nt="";"de"==v.lang&&(nt="https://help.edupage.org/text.php?id=3161&lang=de"),"sk"!=v.lang&&"cz"!=v.lang||(nt="https://help.edupage.org/text.php?id=3161&lang=sk"),nt&&(tt.push([]),tt.push({text:u.action_name("help"),onClick:function(){return window.open(nt,"_blank")}}))}if(De.asklogin){var at=v.ls(4788);return v.loggedUser||(at=l.createElement(l.Fragment,null,v.ls(2853),l.createElement(i.VGap,{height:20}),l.createElement(i.RButton,{label:v.ls(1012),onClick:function(){return document.location.href="/login/"},type:"green"}))),l.createElement(l.Fragment,null,at)}var it=[];if("regular"==X&&fe)for(var st=function(e){if(!ve[e+"_summary"])return"continue";it.push({text:fe.table(e).name(),checked:L.table==e&&"*"==L.id,onClick:function(){return q(s.DBITools.rowid2user(e,"*"))}})},lt=0,ot=["classes","teachers","classrooms"];lt<ot.length;lt++)st(ot[lt]);function ut(e){var t=e.dbi,r=e.rights,n=e.colorsEnabled;t&&pe(t),r&&_e(r),"regular"==X&&null!=n&&$e(n),Je.current=e.print}var ct={},dt=void 0;N||(dt=l.createElement(l.Fragment,null,l.createElement("i",{className:"fa fa-reply fa-rotate-90"}),l.createElement(i.HGap,{width:20}),(ve.classes||De.allow_my_items.classes)&&l.createElement(l.Fragment,null,v.ls(6801),"..."))),"regular"!=X||ie||0!=De.regular.timetables.filter(function(e){return!e.hidden}).length||(dt=l.createElement(l.Fragment,null,0<De.regular.timetables.filter(function(e){return e.year==xe}).length?v.ls(1759):v.ls(1644)+" ("+v.getSchoolYearName(xe)+")",v.hasRight("timetable")&&l.createElement(l.Fragment,null,l.createElement(i.VGap,{height:30}),l.createElement(i.RButton,{label:v.ls(1687),onClick:k,type:"green"}))));var mt=[];be!=we&&mt.push({text:v.ls(1733),onClick:function(){return $(d.week_start(v,we))}}),De.regular.default_num&&!b&&(0<mt.length&&mt.push([]),mt.push({text:v.ls(8735),onClick:function(){return F(De.regular.default_num)}}));var ht=function(e){void 0===e&&(e=!1);var t=e?void 0:ue;return"regular"==X?l.createElement(c.RegularTTView,{tt_num:ie,oblast:O,id:L.id,disableColors:Xe,mode:Q,fixTTColors:re,style:{flex:"1 1 0px",minWidth:100},fit:!0,buildButtonsPortal:e?void 0:function(e){if(de)return m.createPortal(e.map(function(e,t){return Array.isArray(e)?l.createElement(i.HGap,{key:t,width:5}):l.createElement(w,{key:t,text:e.text,icon:e.icon,onClick:e.onclick})}),de)},setViewData:e?void 0:ut,onTTItemClick:t,selectedTTItem:e?void 0:oe}):l.createElement(o.CurrentTTView,{table:L.table,id:L.id,year:xe,datefrom:ke,dateto:Te,showColors:Re,showIgroupsInClasses:He,showOrig:Be,showCurrentTime:!e,showHeader:!0,time_mode:je,swapAxis:Ne,fit:Oe&&!e,onTTItemClick:t,selectedTTItem:e?void 0:oe,setViewData:e?void 0:ut,fixTTColors:re,style:e?void 0:{flex:"1 1 0px",minWidth:100},print:e})},ft=De&&De.regular.timetables.find(function(e){return e.tt_num==ie});return l.createElement("div",{ref:V,id:_?"fitheight":void 0,style:n.__assign({display:"flex",flexDirection:"column",boxSizing:"border-box",minHeight:100,height:0==R?"80vh":_?300:650,background:"#ffffff"},e.style||{})},l.createElement("div",{style:{display:"flex",flexDirection:"row",marginBottom:10,whiteSpace:"pre",overflowX:"auto",overflowY:"hidden"}},De.allow_my_user&&l.createElement(w,{text:v.ls(3883),selected:""!=N&&N==De.allow_my_user,style:{marginRight:15},onClick:function(){return q(De.allow_my_user)},onOverflow:C}),fe&&H.map(function(e){if(!ve[e]&&!De.allow_my_items[e])return null;if("regular"==X&&"igroups"==e)return null;var t=fe.tableData(e).map(function(e){return s.DBITools.rowApplyChanges(e,Te)});if("teachers"==e&&(t=t.filter(function(e){return!e.expired})),!ve[e]){if(!De.allow_my_items[e])return null;t=t.filter(function(t){return De.allow_my_items[e].includes(t.id)})}function r(t,r){var n=fe.rowData(e,t);return{text:ASC.escapeHTML(fe.rowName(e,n.id,v.sort_name_col)+(r||"")),onClick:function(){return q(s.DBITools.rowid2user(e,n.id))},className:n.cb_hidden?"item-old":"",checked:e==L.table&&n.id==L.id}}var a=[];if("students"==e){var i=ASC.lang_getLocale(),o=n.__spreadArrays(t);o.sort(function(t,r){return fe.rowName(e,t.id,v.sort_name_col).localeCompare(fe.rowName(e,r.id,v.sort_name_col),i)});for(var u=function(e){var t=!1,n=o.filter(function(t){return t.classid==e}).map(function(e){var n=r(e.id);return t=t||n.checked,n});if(0==n.length)return"continue";a.push({text:fe.rowName("classes",e),submenu:n,checked:t})},c=0,d=fe.tableIds("classes");c<d.length;c++)u(d[c]);var m=o.map(function(e){return r(e.id,e.classid&&" ("+fe.rowName("classes",e.classid)+")")});a.push([]),a.push({text:v.ls(2824),submenu:m})}else a=s.DBITools.splitItemsForCombo(t).map(function(e){return r(e.id)}),"igroups"==e&&1<fe.tableData(e).length&&ve.igroups_summary&&(a.push([]),a.push({text:v.ls(1349),checked:N==Qe,onClick:function(){return q(Qe)}}));if(0==t.length)return null;var h=O==e&&N!=M;"igroups"==e&&"igroups_summary"==O&&(h=!0);var f=void 0,p=fe.table(e).name();return 2<=R&&(p=void 0,f=fe.table(e).icon()),l.createElement(w,{key:e,text:p,icon:f,selected:h,menu:a,onOverflow:C})}),0<it.length&&l.createElement(w,{text:0==R?v.ls(1250):void 0,icon:0==R?void 0:"/static/pics/schedule_32.png",title:v.ls(1250),menu:it,selected:"*"==L.id}),l.createElement("span",{ref:function(e){return me(e)},style:{marginLeft:10,display:"flex",flexDirection:"row",minWidth:0,flexShrink:1}}),v.hasRight("timetable")&&0==R&&l.createElement(l.Fragment,null,l.createElement(i.HGap,{width:5}),l.createElement(w,{text:u.action_name("customize"),icon:"/global/pics/ui/tools.svg",menu:n.__spreadArrays(et)}),l.createElement(w,{text:v.ls(2340),icon:"/global/pics/ui/timetables_48.svg",onClick:k})),l.createElement("span",{style:{flex:1}}),"regular"==X?l.createElement(l.Fragment,null,l.createElement(w,{text:ft&&ft.hidden?ft.text:v.ls(8735),style:ct,menu:b?void 0:n.__spreadArrays(De.regular.timetables.filter(function(e){return!e.hidden}).map(function(e){return{text:e.text,checked:e.tt_num==ie,onClick:function(){return F(e.tt_num)}}}),v.isAdmin()||v.hasRight("timetable")||v.hasRight("ttadminview")||v.isUcitel()&&!v.hasRight("limited")?[{text:v.ls(8044)+"...",onClick:function(){return n.__awaiter(g,void 0,void 0,function(){var e;return n.__generator(this,function(t){switch(t.label){case 0:return[4,i.RDialog.show(l.createElement(D,null))];case 1:return(e=t.sent())&&F(e),[2]}})})}}]:[],De.current.allow?[[],{text:v.ls(6204),onClick:function(){return j()}}]:[]),enabled:!0})):l.createElement(l.Fragment,null,ye<be&&l.createElement(w,{text:0==R?"<<":"<",style:ct,onClick:function(){return $(d.date_delta(Ee,-1))}}),l.createElement(w,{text:be==we?v.ls(1733):d.date_format_2dates(v,Ee,Ce,0==R),style:ct,menu:mt,enabled:!0}),l.createElement(w,{text:0==R?">>":">",style:ct,onClick:function(){return $(d.date_delta(Ce,1))}})),!b&&l.createElement(w,{text:l.createElement("i",{className:"fa fa-caret-down"}),style:n.__assign(n.__assign({},ct),{color:"#808080"}),menu:tt})),dt&&l.createElement(l.Fragment,null,l.createElement("div",{style:{minHeight:0,flex:"1 1 0px",padding:15,fontSize:16,color:"#a0a0a0",boxSizing:"border-box",display:N?"none":void 0}},dt)),l.createElement("div",{style:{display:dt?"none":"flex",flexDirection:"row",minHeight:0,flex:"1 1 0px"}},l.createElement("div",{style:{display:"flex",flex:"1 1 0px",overflow:"auto",position:"relative"}},ht()),oe&&l.createElement(l.Fragment,null,l.createElement(h.VSeparatorLine,{height:"auto"}),l.createElement(y,{ttitem:oe,dbi:fe,style:{width:250,marginRight:10},onClose:function(){return ue(null)}}))))}function w(e){var t=i.useHoverWithMenu(),r=t[0],a=t[1],s=t[2],o=l.createRef(),u=e.text,c=e.icon,d=e.title,m=e.selected,h=e.onOverflow,f=!(!e.onClick&&!e.menu),p=e.enabled;return null==p&&(p=f),i.useDomReader(function(){var e=o.current;e&&e.scrollWidth>e.offsetWidth&&h&&h()}),l.createElement("span",n.__assign({ref:o},a,{title:d||("string"==typeof u?u:""),style:n.__assign({background:p&&(r||m)?"#E3F2FD":void 0,padding:"10px 15px",borderTop:"2px solid "+(m?"#2196F3":"rgba(0,0,0,0)"),cursor:f?"pointer":void 0,textTransform:"uppercase",fontSize:12,fontWeight:m?"bold":void 0,color:p?"#333":"#ccc",flexShrink:1,minWidth:10,overflow:"hidden",textOverflow:u?"ellipsis":void 0},e.style||{}),onClick:function(t){t.preventDefault(),t.stopPropagation(),e.onClick?e.onClick(t):e.menu&&s(e.menu,t.currentTarget)},onMouseDown:function(e){return e.preventDefault()}}),c&&l.createElement("img",{src:c,style:{maxHeight:16,filter:p?void 0:"grayscale(100%) opacity(50%)",marginRight:u?5:void 0,verticalAlign:"middle"}}),u)}function y(e){var t=e.ttitem,r=e.dbi,s=e.onClose,o=e.inDlg||!1,u=a.client_req,c=i.useColors(),m=t.type,f=t.date,p=t.eventids,g=t.dpRow,b=u.ls(1301),w="/static/pics/subject_32.svg";switch(m){case"event":b=u.ls(1831),w="/global/pics/ui/events_32.svg";break;case"classroomsupervision":b=u.ls(1723);break;case"absent":b=u.ls(1846),w="/global/pics/ui/subst_32.svg";break;case"subst_duty":b=u.localize("{tt:1471} ({1003})"),w="/substitution/pics/must_be_32.svg";break;case"other":w=b=""}function y(e,t){return r.tools.itemName(e)+": "+r.rowNames(e,t)}var k,T=l.useCallback(function(e){return l.createElement("div",{style:n.__assign({fontSize:16,marginBottom:5},e.style||{})},e.children)},[]),x=r.tools.ttitem_popis(t);return l.createElement("div",{style:n.__assign({position:"relative",background:c.bgWhite},e.style||{})},l.createElement(h.DlgHeader,{title:b,inDlg:o,icon:w,small:!0}),s&&l.createElement("i",{className:"fa fa-times",style:{position:"absolute",right:0,top:0,cursor:"pointer",fontSize:16,color:c.faintIcon},onClick:s}),l.createElement("div",{style:{padding:e.addPadding?"0px 10px 10px 10px":void 0}},l.createElement(T,null,d.date_format_day(u,f,!1)),t.starttime&&l.createElement(T,null,d.date_format_time0(u,t.starttime,{ajSekundy:!1})+"-"+d.date_format_time0(u,t.endtime,{ajSekundy:!1})),l.createElement(i.VGap,{height:15}),g?l.createElement(l.Fragment,null,i.wrapSuspense(l.createElement(_,{dpRow:g,dbi:r,date:f,mode:"ttviewer"}))):l.createElement(l.Fragment,null,t.name&&l.createElement(T,null,t.name),t.subjectid&&l.createElement(T,null,("subjects",y("subjects",(k=t.subjectid)?[k]:[]))),x.class&&l.createElement(T,null,r.tools.itemName(t.igroupid?"igroups":"classes")+": "+x.class),0<t.teacherids.length&&l.createElement(T,null,y("teachers",t.teacherids)),0<t.classroomids.length&&l.createElement(T,null,y("classrooms",t.classroomids)),t.studentids&&0<t.studentids.length&&t.studentids.length<=3&&l.createElement(T,null,y("students",t.studentids)),p&&l.createElement(l.Fragment,null,l.createElement(i.VGap,{height:10}),p.map(function(e){return l.createElement(v.EventBar,{key:e,eventid:e,where:"timetable"})})))))}function k(){document.location.href="/timetable/admin.php"}function T(){ASC.ASC_action("/gcall",{gadget:"TimetableVersionAdmin",action:"settings",gsh:ASC.gsechash})}function x(){ASC.ASC_action("/gcall",{gadget:"TimetableVersionAdmin",action:"rights",gsh:ASC.gsechash})}function E(e){var t=l.useState(void 0),r=t[0];return[void 0===r?e:r,t[1]]}function C(e){var t=i.useReq();return l.createElement(i.RDialog,{width:1150,height:750,buttons:["close"],header:t.ls(1001)},l.createElement(b,n.__assign({},e)))}function D(e){var t=i.useReq(),r=g.useMainDBI(t.getSchoolYear(),{needed_part:{timetables:["stav","name","year","datefrom","dateto","filetime_int","_uial"]},needed_combos:{timetables:["stav"]}}),n=r.tableData("timetables").filter(function(e){return 0<e._uial});n.sort(function(e,t){return t.filetime_int-e.filetime_int});var a=i.useStateValueRef("");return l.createElement(i.RDialog,{onConfirm:function(e){return e.confirmClose(a.value)},width:700,height:400,buttons:[{label:t.ls(1489),action:"view",type:a.value?"green":void 0},"cancel"]},l.createElement(p.RDatatable,{data:n,dbi:r,dbi_table:"timetables",cssClass:"light-theme",columns:["stav","year","name","datefrom","dateto"].map(function(e){return{key:e,width:{name:200,stav:100}[e]||80}}),fitWidth:!0,selectedIdRef:a,idcol:"id"}))}(e.TTViewer=b).needed_part=s.typed({teachers:["__name","cb_hidden","expired"],classes:["__name"],classrooms:["__name"],igroups:["__name"],students:["__name","classid"],subjects:["__name"]}),e.TopButton=w,e.TTItemDetails=y,e.showTTViewerDlg=function(e){return n.__awaiter(this,void 0,void 0,function(){return n.__generator(this,function(t){return i.RDialog.show(l.createElement(C,n.__assign({},e))),[2]})})},e._hotswap=[C,D]},"/timetable/currenttt.js":function(e,t,r){e.__esModule=!0;var n=t("tslib"),a=t("react"),i=t("../asc/edurequest"),s=t("../asc/asc_react"),l=t("../rpr/dbi_react"),o=t("../asc/lib_date"),u=t("../substitution/online/timetable"),c=t("./server/currenttt"),d=t("./ttview_components"),m=t("../rpr/dbi"),h=t("./ttviewer"),f=t("./app/ttdoc"),p=t("../asc/actions"),g={ttitems:[],rights:{}};function v(e){var t,r=i.client_req,p=e.table,v=e.id,_=e.year,b=e.datefrom,w=e.dateto,y=e.showColors,k=e.showIgroupsInClasses,T=e.showOrig,x=e.showCurrentTime,E=e.showHeader,C=e.fit,D=e.onTTItemClick,S=e.selectedTTItem,R=e.highlightTTItem,I=e.time_mode,A=e.print,B=e.fixTTColors,V=s.useClientSize(),W=V[0],H=V[1],M=V[2],P=s.useColors(),j=a.useState(""),F=j[0],z=j[1];a.useEffect(function(){if(x){var e=function(){return z(r.timezone_datetime())};e();var t=setInterval(e,5e3);return function(){return clearInterval(t)}}z("")},[x]);var N=l.useMainDBI(_,{needed_part:m.DBITools.mergeNeededParts(h.TTViewer,{subjects:["name","short"],teachers:["firstname","lastname","short"],classes:["__name","classroomid"],igroups:["__name"],classrooms:["name","short"],students:["classid"],events:["typ","name"],event_types:["name","icon"],subst_absents:["date","absent_typeid","groupname"],periods:["__name","period","starttime","endtime"],dayparts:["starttime","endtime"],dates:["tt_num","tt_day"]}),vt_filter:{datefrom:b,dateto:w},interactive:!1}),q=s.useAsyncMemo(function(){return c.curentttGetData(null,{year:_,datefrom:b,dateto:w,table:p,id:v,showColors:y,showIgroupsInClasses:k,showOrig:T,log_module:"CurrentTTView"})},[_,b,w,p,v,y,k,T],g,{inputs_reset:[p],interactive:!1});a.useEffect(function(){e.setViewData&&q!=g&&e.setViewData({dbi:N,rights:q.rights})},[N,q]);var L=q.error,O=q.week_name,G=null!==(t=e.swapAxis)&&void 0!==t?t:q.swapAxis,U=I&&r.jeZUS()?"hours":"periods",Y=a.useMemo(function(){var e=q.ttitems;return B&&(e=e.map(function(e){return e.colors&&(e=n.__assign(n.__assign({},e),{colors:e.colors.map(function(e){return f.fixTTColor(e,P.darkMode)})})),e})),e},[q,B,P.darkMode]),$=o.date_interval_array(b,w).filter(function(e){if(o.date_isWeekend(r,e)){for(var t=0,n=Y;t<n.length;t++){var a=n[t];if(a.date==e&&"out"!=a.type){if(a.eventid){var i=N.rowData("events",a.eventid);if(i&&("holiday"==i.typ||"sholiday"==i.typ))continue}return!0}}return!1}return!0}),K=d.calcTTViewBoxes({clientWidth:W,clientHeight:H,fit:C,print:A,swapAxis:G,showHeader:E,time_mode:I,nDays:$.length,nPeriods:N.tableData("periods").length}),X=K.gap,Z=K.gap_day,J=K.ttWidth,Q=K.periodHeight,ee=K.rowHeight,te=K.dayWidth,re=K.headerWidth,ne=K.headerHeight,ae=K.ttBox,ie=K.weekBox,se=K.ttRowBox,le=u.makeTLR(N,null,"dates",I||!1,J,Q,{periods:q.periods});return le.qSide=18,le.gap=X,a.createElement(a.Fragment,null,a.createElement("div",{ref:M,style:n.__assign(n.__assign(n.__assign({},d.ttview_div_style),{backgroundColor:P.bgWhite,color:P.fgBlack}),e.style||{}),className:"print-nobreak"},a.createElement(d.TTView_PageHeader,{dbi:N,table:p,id:v,headerWidth:re,headerHeight:ne}),L||a.createElement(d.TTView_Boxes,{swapAxis:G,ttBox:ae,tt:$.map(function(e,t){return a.createElement(d.TTView_TTDay,{key:e,dbi:N,box:se(t),gap_day:Z,table:p,id:v,tlr:le,ttitems:N.mock?[]:Y.filter(function(t){return t.date==e}),onTTItemClick:D,selectedTTItem:S,highlightTTItem:R,swapAxis:G,gridMode:U,showTime:F.substr(0,10)==e?F.substr(11):""})}),days:$.map(function(e,t){var r=ee*t,n={x1:0,x2:te,y1:r,y2:r+ee};return a.createElement(d.TTView_Day,{key:e,date:e,box:n,splitLineTop:0<t,swap:G})}),periods:a.createElement(d.TTView_Periods,{dbi:N,periodHeight:Q,tlr:le,swapAxis:G,showTime:!0,periods:q.periods,gridMode:U}),corner:O&&a.createElement(s.RTextBox,n.__assign({},s.swapBox(ie,G),{text:O,vAlign:"center",hAlign:"center",style:{fontSize:12,background:P.bgWhite}}))})))}function _(e){var t,r=e.year,n=e.datefrom,o=e.dateto,u=e.table,c=e.id,d=e.highlightTTItem,m=e.highlightName,h=l.useMainDBI(r,{needed_part:(t={},t[u]=["__name"],t)}),f=i.client_req,g=s.useStateValueRef(!0);return a.createElement(s.RDialog,{header:p.action_name("timetable")+": "+h.rowName(u,c),width:800,height:600,allowMaximizeBtn:!0,footer:a.createElement(a.Fragment,null,d&&a.createElement(s.RCheckBox,{valueRef:g,label:f.ls(1113)+": "+m}))},a.createElement(v,{datefrom:n,dateto:o,table:u,id:c,year:r,showColors:!0,highlightTTItem:g.value?d:void 0,fit:!0,style:{flex:"1 1 0px",minWidth:100}}))}e.CurrentTTView=v,e.showCurrentTimetable=function(e){return n.__awaiter(this,void 0,void 0,function(){var t,r,l,u;return n.__generator(this,function(n){return t=i.client_req,r=e.datefrom||o.week_start(t,e.week),l=e.dateto||o.week_end(t,e.week),u=e.year||t.getSchoolYear(l),[2,s.RDialog.show(a.createElement(_,{table:e.table,id:e.id,datefrom:r,dateto:l,year:u,highlightTTItem:e.highlightTTItem,highlightName:e.highlightName}))]})})},e._hotswap=[_]},"/timetable/server/currenttt.js":function(e,t,r){r.implementRpc(["curentttGetData"])},"/timetable/regulartt.js":function(e,t,r){e.__esModule=!0;var n=t("tslib"),a=t("react"),i=t("../asc/asc_react"),s=t("../rpr/dbi"),l=t("../asc/edurequest"),o=t("./server/regulartt"),u=t("./app/ttdoc"),c=t("./app/rokobject"),d=t("./app/print"),m=t("./ttviewer"),h=t("./ttview_components"),f=t("../substitution/online/timetable"),p=t("./ttitem");function g(e){var t=e.dbi,r=e.data,s=e.disableColors,l=e.oblast,o=e.id,u=e.buildButtonsPortal,m=e.fixTTColors,h=i.useClientSize(),f=h[0],p=h[1],g=h[2],v=a.useRef(),b=a.useState(0),w=b[0],y=b[1],k=a.useState(e.fit?-1:4),T=k[0],x=k[1],E=i.useReq(),C=a.useMemo(function(){if(!t)return[];var e=function(e){var t=new c.CRok;for(var r in c.ttapp_needed_part)if(t.m_ObjectsI[r])for(var n=0,a=e.tableData(r);n<a.length;n++){var i=a[n];t.addRow(r,i),t.dbi.addRow(r,i)}return t.StructureFromData(),t}(t),r=_(t,l);if(!r)return[];var n={};o&&(n[l]=[o]);var a=e.m_ObjectsI.ttreports[r];return a.m_bTTViewerDisableCardColor=!!s,a.Render({filter:n,m_bTTViewer:!1,fixTTColors:m})},[t,s,l,o,m]);a.useEffect(function(){w>=C.length&&y(0)},[w,C]);var D=C[w];a.useEffect(function(){if(e.setViewData&&r){var n=t?t.rowData("ttreports",_(t,l)):null;e.setViewData({dbi:t,rights:r.rights,colorsEnabled:!!n&&n.cardcolorenabled,print:function(){return d.printPagesPrint([D])}})}},[r,t,l,D]);var S=T;D&&T<0&&(S=10*Math.min(f/D.width,p/D.height)),a.useEffect(function(){var e=$j(v.current);if(e.empty(),D){D.$sheet=e;var t=S;D.RenderSheet(e,t,!1)}else e.text(E.ls(8467))},[w,C,S]);var R=[];1<C.length&&(R.push({id:"prevWeek",icon:"/static/pics/preview_back_32.png",onclick:0<w?function(){return y(w-1)}:void 0}),R.push({id:"nextWeek",icon:"/static/pics/preview_forward_32.png",onclick:w+1<C.length?function(){return y(w+1)}:void 0}));var I=-1,A=-1;return[2,3,4,6,10].forEach(function(e){e<S/1.1&&(A=e),1.1*S<e&&I<0&&(I=e)}),0<R.length&&R.push([]),R.push({icon:"/static/pics/zoom_plus_32.png",onclick:0<I?function(){return x(I)}:void 0}),R.push({icon:"/static/pics/zoom_minus_32.png",onclick:0<A?function(){return x(A)}:void 0}),0<T&&R.push({text:E.ls(1915),onclick:function(){return x(-1)}}),a.createElement(a.Fragment,null,a.createElement("div",{ref:g,className:"print-nobreak",style:n.__assign({position:"relative",overflow:"auto"},e.style||{})},a.createElement("div",{ref:v,style:{marginLeft:"auto",marginRight:"auto",position:"relative"}})),u&&u(R))}function v(e){var t,r,l,o,c,d=e.dbi,m=e.data,g=e.oblast,v=e.id,b=e.fixTTColors,w=e.buildButtonsPortal,y=null===(t=e.showHeader)||void 0===t||t,k=i.useClientSize(),T=k[0],x=k[1],E=k[2];T=null!==(r=e.clientWidth)&&void 0!==r?r:T,x=null!==(l=e.clientHeight)&&void 0!==l?l:x;var C=i.useColors(),D=a.useState(0),S=D[0],R=D[1],I=a.useState(0),A=I[0],B=I[1];a.useEffect(function(){if(e.setViewData&&m){var t=d?d.rowData("ttreports",_(d,g)):null;e.setViewData({dbi:d,rights:m.rights,colorsEnabled:!!t&&t.cardcolorenabled})}},[m,d,g]);var V=g,W="";"classes"==V&&(W=v),"students"==V&&(W=(null===(o=null==d?void 0:d.rowData("students",v))||void 0===o?void 0:o.classid)||"");var H=null==d?void 0:d.rowData("ttreports",_(d,g)),M=!e.disableColors&&(null==H?void 0:H.cardcolorenabled)&&((null==H?void 0:H.cardcolortable1)||("teachers"==V?"classes":"teachers")),P=a.useMemo(function(){if(!d)return[];for(var e=[],t=0,r=d.tableData("cards");t<r.length;t++){var n=r[t];if(n.days){var a=d.rowData("lessons",n.lessonid),i={type:"card",days:n.days,weeks:n.weeks,terms:a.terms,date:"",uniperiod:n.period,starttime:"",endtime:"",subjectid:a.subjectid,classids:a.classids,teacherids:a.teacherids,groupnames:a.groupnames,classroomids:n.classroomids,studentids:a.studentids,durationperiods:a.durationperiods};if(p.ttitemFilterMatch(i,V,v)){if("classes"==V){var l=d.rowDatas("groups",a.groupids).find(function(e){return e.classid==v});if(l){var o=d.rowData("divisions",l.divisionid);i.cellSlices="";for(var c=0,h=o.groupids;c<h.length;c++){var f=h[c];i.cellSlices+=a.groupids.includes(f)?"1":"0"}}}e.push(i)}}}if(m.rights.classroomsupervision&&("teachers"==V||"classrooms"==V))for(var g=d.tableIds("days"),_=function(t){var r=!1;if("teachers"==V&&(r=t.teacherid==v),"classrooms"==V&&(r=t.classroomid==v),!r)return"continue";var n={type:"classroomsupervision",days:g.map(function(e){return t.day==e?"1":"0"}).join(""),weeks:t.weeks,date:"",uniperiod:s.DBITools.getUniPeriod(t),starttime:"",endtime:"",subjectid:"",classids:[],teacherids:t.teacherid?[t.teacherid]:[],groupnames:[],classroomids:[t.classroomid]};e.push(n)},w=0,y=d.tableData("classroomsupervisions")||[];w<y.length;w++)_(y[w]);for(var k=0,T=e;k<T.length;k++)i=T[k],M&&(i.colors=p.ttitemTableIds(i,M).map(function(e){var t;return null===(t=d.rowData(M,e))||void 0===t?void 0:t.color}).filter(function(e){return e}),b&&(i.colors=i.colors.map(function(e){return u.fixTTColor(e,C.darkMode)})));return e},[d,V,v,M,b,C.darkMode]),j=a.useMemo(function(){for(var e,t,r={terms:!1,weeks:!1},n=0,a=P;n<a.length;n++){var i=a[n];(null===(e=i.weeks)||void 0===e?void 0:e.includes("0"))&&(r.weeks=!0),(null===(t=i.terms)||void 0===t?void 0:t.includes("0"))&&(r.terms=!0)}return r},[P]);if(!d||!H)return null;var F=d.tableData("periods"),z=d.rowData("periods","0")?0:1,N=F.length||1;if(W){var q=null===(c=d.rowData("classes",W))||void 0===c?void 0:c.bell;if(q){var L=d.rowData("bells",q);F=F.map(function(e){var t=s.patchmissingobj(null==L?void 0:L.perioddata[e.id],{});return n.__assign(n.__assign({},e),{starttime:t.starttime||e.starttime,endtime:t.endtime||e.endtime})})}}var O=d.tableData("days"),G=H.row_tables.includes("periods"),U=h.calcTTViewBoxes({clientWidth:T,clientHeight:x,fit:!1,swapAxis:G,showHeader:y,time_mode:!1,nDays:O.length||1,nPeriods:N}),Y=U.gap,$=U.gap_day,K=U.ttWidth,X=U.periodHeight,Z=U.rowHeight,J=U.dayWidth,Q=U.headerWidth,ee=U.headerHeight,te=U.ttBox,re=U.ttRowBox,ne=U.weekBox,ae=new f.TimetableLayoutRenderer(K,X,z,z+N);ae.qSide=18,ae.gap=Y,ae.data2t=function(e){var t,r=e.period||e.uniperiod;if("b"==r[0]){var n=parseInt(r.substr(1));return{t1:n,t2:n}}var a=parseInt(r);return{t1:a,t2:a+(null!==(t=e.durationperiods)&&void 0!==t?t:1)}};var ie=[];return(j.terms||j.weeks)&&(ie.push({id:"prevWeek",icon:"/static/pics/preview_back_32.png",onclick:0<S||0<A?function(){0<S?R(S-1):(R(d.tableData("weeks").length-1),B(A-1))}:void 0}),ie.push({id:"nextWeek",icon:"/static/pics/preview_forward_32.png",onclick:A+1<d.tableData("terms").length||S+1<d.tableData("weeks").length?function(){S+1<d.tableData("weeks").length?R(S+1):(R(0),B(A+1))}:void 0})),a.createElement(a.Fragment,null,a.createElement("div",{ref:E,style:n.__assign(n.__assign(n.__assign({},h.ttview_div_style),{backgroundColor:C.bgWhite,color:C.fgBlack}),e.style||{})},a.createElement(h.TTView_PageHeader,{dbi:d,table:V,id:v,headerWidth:Q,headerHeight:ee}),a.createElement(h.TTView_Boxes,{ttBox:te,swapAxis:G,periods:a.createElement(h.TTView_Periods,{dbi:d,periodHeight:X,tlr:ae,swapAxis:G,showTime:!0,periods:s.unpartial_array(F)}),days:O.map(function(e,t){var r=Z*t,n={x1:0,x2:J,y1:r,y2:r+Z};return a.createElement(h.TTView_Object,{key:e.id,box:n,dbi:d,table:"days",id:e.id,splitLineTop:0<t,swap:G})}),tt:O.map(function(t,r){return a.createElement(h.TTView_TTDay,{key:r,dbi:d,box:re(r),gap_day:$,table:g,id:v,tlr:ae,ttitems:P.filter(function(e){var t,n;return"1"==e.days[r]&&"0"!=(null===(t=e.weeks)||void 0===t?void 0:t[S])&&"0"!=(null===(n=e.terms)||void 0===n?void 0:n[A])}),onTTItemClick:e.onTTItemClick,selectedTTItem:e.selectedTTItem,swapAxis:G})}),corner:a.createElement(i.RTextBox,n.__assign({},i.swapBox(ne,G),{vAlign:"center",text:[["terms",A],["weeks",S]].map(function(e){var t=e[0],r=e[1];return j[t]&&a.createElement("div",{key:t,style:{textAlign:"center"}},d.rowName(t,""+r))})}))})),w&&w(ie))}function _(e,t){for(var r=0,n=e.tableData("ttreports");r<n.length;r++){var a=n[r];if("teachers_summary"==t&&6==a.typ)return a.id;if("classes_summary"==t&&5==a.typ)return a.id;if("classrooms_summary"==t&&7==a.typ)return a.id;if(a.page_tables.includes(t))return a.id}return""}(e.RegularTTView=function(e){var t=e.tt_num,r=l.client_req,u=i.useAsyncMemo(function(){return e.ttdata?Promise.resolve(e.ttdata):o.regularttGetData(null,t)},[t],{rights:{}},{interactive:!1}),c=a.useMemo(function(){return u.dbiAccessorRes?s.DBI.fromAccessorResult(r,u.dbiAccessorRes):null},[u]),d=e.mode||"svg";e.oblast.endsWith("_summary")&&(d="svg");var h=e.onTTItemClick;return r.isApp()&&(h=function(e){return i.RDialog.show(a.createElement(i.RDialog,{header:r.ls(1920),width:300,buttons:r.isApp()?[]:["close"],noPadding:!0},a.createElement(m.TTItemDetails,{ttitem:e,dbi:c,addPadding:!0})))}),"html"==d?a.createElement(v,n.__assign({},e,{dbi:c,data:u,onTTItemClick:h})):a.createElement(g,n.__assign({},e,{dbi:c,data:u}))}).npp=s.neededPartProvider(function(){return[v,g]}),g.npp=s.neededPartProvider(function(){return[c.ttapp_needed_part]}),v.needed_part=s.typed({students:["classid"],classes:["classroomid"],lessons:["studentids","groupnames"],groups:["classid","divisionid"],divisions:["groupids"],days:["__name"],weeks:["__name"],terms:["__name"],classroomsupervisions:["weeks"]}),e._hotswap=[g]},"/timetable/server/regulartt.js":function(e,t,r){r.implementRpc(["regularttGetData","ttviewDBIAccessor"])},"/timetable/server/ttviewer.js":function(e,t,r){r.implementRpc(["getTTViewerData"])}});